worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 512;
}

http {
    include /etc/nginx/mime.types;
    default_type application/json;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';
    access_log /var/log/nginx/access.log main;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Upstream services
    upstream nlp_service {
        server nlp-service:3002;
        keepalive 16;
    }

    upstream transaction_builder {
        server transaction-builder:3003;
        keepalive 16;
    }

    # Note: zklogin-service removed - using external Mysten Labs APIs
    # Salt: https://salt.api.mystenlabs.com/get_salt
    # Prover (testnet): https://prover-dev.mystenlabs.com/v1
    # Prover (mainnet): https://prover.mystenlabs.com/v1

    upstream user_service {
        server user-service:3005;
        keepalive 16;
    }

    upstream notification_service {
        server notification-service:3006;
        keepalive 16;
    }

    # Internal API Gateway
    server {
        listen 8080;
        server_name _;

        # NLP Service routes
        location /api/v1/nlp/ {
            proxy_pass http://nlp_service/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Transaction Builder routes
        location /api/v1/tx/ {
            proxy_pass http://transaction_builder/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # zkLogin routes - Now proxied to external Mysten Labs APIs
        # These routes are handled client-side or via telegram-gateway
        # Keeping location for backwards compatibility - returns redirect info
        location /api/v1/zklogin/ {
            return 200 '{"status":"external","salt_service":"https://salt.api.mystenlabs.com/get_salt","prover_dev":"https://prover-dev.mystenlabs.com/v1","prover_prod":"https://prover.mystenlabs.com/v1"}\n';
            add_header Content-Type application/json;
        }

        # User Service routes
        location /api/v1/users/ {
            proxy_pass http://user_service/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Notification Service routes
        location /api/v1/notifications/ {
            proxy_pass http://notification_service/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Health check
        location /health {
            access_log off;
            return 200 '{"status":"healthy"}\n';
            add_header Content-Type application/json;
        }
    }
}
